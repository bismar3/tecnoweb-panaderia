<!-- usuarios.html - SIN <html>, <head>, solo contenido -->
<div class="usuarios-container" style="padding: 20px;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h1><i class="fas fa-user-shield"></i> Gesti√≥n de Usuarios</h1>
        <button id="btnNuevoUsuario" style="background: #3b82f6; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">
            <i class="fas fa-plus"></i> Nuevo Usuario
        </button>
    </div>

    <!-- Filtros -->
    <div style="background: white; padding: 15px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
            <input type="text" id="buscarUsuario" placeholder="Buscar por nombre o email..." style="padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
            <select id="filtroEstado" style="padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                <option value="">Todos los estados</option>
                <option value="true">Activo</option>
                <option value="false">Inactivo</option>
            </select>
        </div>
    </div>

    <!-- Tabla -->
    <div style="background: white; border-radius: 8px; overflow-x: auto; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
        <table id="tablaUsuarios" style="width: 100%; border-collapse: collapse; min-width: 800px;">
            <thead style="background: #f3f4f6;">
                <tr>
                    <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e5e7eb;">ID</th>
                    <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e5e7eb;">Nombre</th>
                    <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e5e7eb;">Email</th>
                    <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e5e7eb;">Roles</th>
                    <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e5e7eb;">Estado</th>
                    <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e5e7eb;">√öltimo Acceso</th>
                    <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e5e7eb;">Acciones</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <!-- Modal Usuario -->
    <div id="modalUsuario" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); justify-content: center; align-items: center; z-index: 1000;">
        <div style="background: white; padding: 30px; border-radius: 10px; width: 90%; max-width: 600px; max-height: 90vh; overflow-y: auto;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2 id="modalTitle">Nuevo Usuario</h2>
                <button id="btnCerrarModal" style="background: none; border: none; font-size: 28px; cursor: pointer; color: #666;">&times;</button>
            </div>
            <form id="formUsuario">
                <input type="hidden" name="id_usuario">
                
                <!-- Nombre -->
                <label style="display: block; margin-bottom: 5px; font-weight: 600;">Nombre Completo:</label>
                <input type="text" name="nombre" required style="width: 100%; padding: 10px; margin-bottom: 15px; border: 1px solid #ddd; border-radius: 5px; box-sizing: border-box;">
                
                <!-- Email -->
                <label style="display: block; margin-bottom: 5px; font-weight: 600;">Email:</label>
                <input type="email" name="email" required style="width: 100%; padding: 10px; margin-bottom: 15px; border: 1px solid #ddd; border-radius: 5px; box-sizing: border-box;">
                
                <!-- Contrase√±a -->
                <div id="passwordFields">
                    <label style="display: block; margin-bottom: 5px; font-weight: 600;">Contrase√±a:</label>
                    <div style="position: relative;">
                        <input type="password" name="password" id="inputPassword" placeholder="M√≠nimo 8 caracteres" style="width: 100%; padding: 10px; padding-right: 40px; margin-bottom: 5px; border: 1px solid #ddd; border-radius: 5px; box-sizing: border-box;">
                        <button type="button" id="togglePassword" style="position: absolute; right: 10px; top: 10px; background: none; border: none; cursor: pointer; font-size: 1.2em;">üëÅÔ∏è</button>
                    </div>
                    <small style="color: #666; display: block; margin-bottom: 15px;">Debe tener al menos 8 caracteres, una may√∫scula, una min√∫scula y un n√∫mero</small>
                </div>
                
                <!-- Roles -->
                <label style="display: block; margin-bottom: 5px; font-weight: 600;">Roles:</label>
                <div id="rolesCheckboxes" style="border: 1px solid #ddd; border-radius: 5px; padding: 10px; margin-bottom: 10px; max-height: 150px; overflow-y: auto; background: #f9fafb;">
                    <!-- Se llenar√° din√°micamente -->
                </div>
                
                <!-- Bot√≥n Permisos Individuales -->
                <button type="button" id="btnGestionarPermisos" style="width: 100%; background: #8b5cf6; color: white; border: none; padding: 10px; border-radius: 5px; cursor: pointer; font-size: 14px; margin-bottom: 15px;">
                    <i class="fas fa-key"></i> Gestionar Permisos Individuales
                </button>
                
                <!-- Estado -->
                <label style="display: block; margin-bottom: 5px; font-weight: 600;">Estado:</label>
                <select name="estado" style="width: 100%; padding: 10px; margin-bottom: 20px; border: 1px solid #ddd; border-radius: 5px;">
                    <option value="true">Activo</option>
                    <option value="false">Inactivo</option>
                </select>
                
                <!-- Bot√≥n Guardar -->
                <button type="submit" style="width: 100%; background: #10b981; color: white; border: none; padding: 12px; border-radius: 5px; cursor: pointer; font-size: 16px; font-weight: 600;">
                    <i class="fas fa-save"></i> Guardar Usuario
                </button>
            </form>
        </div>
    </div>

    <!-- Modal Permisos Individuales -->
    <div id="modalPermisos" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); justify-content: center; align-items: center; z-index: 1001;">
        <div style="background: white; padding: 30px; border-radius: 10px; width: 90%; max-width: 700px; max-height: 85vh; overflow-y: auto;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 2px solid #e5e7eb; padding-bottom: 15px;">
                <div>
                    <h2 style="margin: 0;">üîë Permisos Individuales</h2>
                    <small style="color: #666;">Selecciona permisos adicionales aparte de los que vienen con los roles</small>
                </div>
                <button id="btnCerrarModalPermisos" style="background: none; border: none; font-size: 28px; cursor: pointer; color: #666;">&times;</button>
            </div>
            
            <!-- Buscador de permisos -->
            <div style="margin-bottom: 20px;">
                <input type="text" id="buscarPermiso" placeholder="üîç Buscar permiso..." style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; box-sizing: border-box;">
            </div>

            <!-- Contenedor de permisos por m√≥dulo -->
            <div id="permisosContainer" style="max-height: 400px; overflow-y: auto;">
                <!-- Se llenar√° din√°micamente -->
            </div>

            <div style="margin-top: 20px; display: flex; gap: 10px;">
                <button id="btnSeleccionarTodos" style="flex: 1; background: #3b82f6; color: white; border: none; padding: 10px; border-radius: 5px; cursor: pointer;">
                    Seleccionar Todos
                </button>
                <button id="btnDeseleccionarTodos" style="flex: 1; background: #6b7280; color: white; border: none; padding: 10px; border-radius: 5px; cursor: pointer;">
                    Deseleccionar Todos
                </button>
            </div>

            <button id="btnGuardarPermisos" style="width: 100%; background: #10b981; color: white; border: none; padding: 12px; border-radius: 5px; cursor: pointer; font-size: 16px; font-weight: 600; margin-top: 15px;">
                <i class="fas fa-check"></i> Aplicar Permisos
            </button>
        </div>
    </div>
</div>

<script>
(async function() {
    console.log('üöÄ Inicializando m√≥dulo de usuarios...');
    
    const api = window.api;
    
    if (!api) {
        console.error('‚ùå API no est√° disponible');
        return;
    }
    
    const tabla = document.querySelector('#tablaUsuarios tbody');
    const modal = document.getElementById('modalUsuario');
    const modalPermisos = document.getElementById('modalPermisos');
    const form = document.getElementById('formUsuario');
    const btnNuevo = document.getElementById('btnNuevoUsuario');
    const btnCerrar = document.getElementById('btnCerrarModal');
    const btnCerrarPermisos = document.getElementById('btnCerrarModalPermisos');
    const btnGestionarPermisos = document.getElementById('btnGestionarPermisos');
    const filtroEstado = document.getElementById('filtroEstado');
    const buscarUsuario = document.getElementById('buscarUsuario');
    const rolesCheckboxes = document.getElementById('rolesCheckboxes');
    const permisosContainer = document.getElementById('permisosContainer');
    const inputPassword = document.getElementById('inputPassword');
    const passwordFields = document.getElementById('passwordFields');

    let rolesDisponibles = [];
    let permisosDisponibles = [];
    let permisosSeleccionados = []; // Permisos individuales adicionales

    // Toggle password
    document.getElementById('togglePassword')?.addEventListener('click', function() {
        const type = inputPassword.getAttribute('type') === 'password' ? 'text' : 'password';
        inputPassword.setAttribute('type', type);
        this.textContent = type === 'password' ? 'üëÅÔ∏è' : 'üôà';
    });

    // Mostrar modal nuevo usuario
    btnNuevo.onclick = () => {
        form.reset();
        form.querySelector('[name="id_usuario"]').value = '';
        document.getElementById('modalTitle').textContent = 'Nuevo Usuario';
        passwordFields.style.display = 'block';
        inputPassword.required = true;
        
        const checkboxes = rolesCheckboxes.querySelectorAll('input[type="checkbox"]');
        checkboxes.forEach(cb => cb.checked = false);
        
        permisosSeleccionados = [];
        
        modal.style.display = 'flex';
    };

    // Cerrar modales
    btnCerrar.onclick = () => modal.style.display = 'none';
    btnCerrarPermisos.onclick = () => modalPermisos.style.display = 'none';
    modal.onclick = (e) => { if (e.target === modal) modal.style.display = 'none'; };
    modalPermisos.onclick = (e) => { if (e.target === modalPermisos) modalPermisos.style.display = 'none'; };

    // Abrir modal de permisos
    btnGestionarPermisos.onclick = () => {
        modalPermisos.style.display = 'flex';
        renderizarPermisos();
    };

    // Cargar roles
    async function cargarRoles() {
        try {
            const response = await api.get('/roles');
            console.log('üìã Respuesta roles:', response.data);
            
            rolesDisponibles = response.data.data || response.data;
            
            if (!Array.isArray(rolesDisponibles)) {
                console.error('‚ùå Roles no es un array');
                rolesCheckboxes.innerHTML = '<p style="color: red;">Error al cargar roles</p>';
                return;
            }
            
            rolesCheckboxes.innerHTML = rolesDisponibles.map(rol => `
                <label style="display: flex; align-items: center; gap: 8px; padding: 8px; cursor: pointer; border-radius: 4px; transition: background 0.2s;" 
                       onmouseover="this.style.background='#e0e7ff'" 
                       onmouseout="this.style.background='transparent'">
                    <input type="checkbox" name="roles[]" value="${rol.id_rol}" style="cursor: pointer; width: 16px; height: 16px;">
                    <div>
                        <span style="font-size: 14px; font-weight: 600;">${rol.nombre}</span>
                        ${rol.descripcion ? `<br><small style="color: #666;">${rol.descripcion}</small>` : ''}
                    </div>
                </label>
            `).join('');
            
            console.log('‚úÖ Roles cargados:', rolesDisponibles.length);
        } catch (error) {
            console.error('‚ùå Error cargando roles:', error);
            rolesCheckboxes.innerHTML = '<p style="color: red;">Error al cargar roles. Verifica que el backend est√© corriendo.</p>';
        }
    }

    // Cargar permisos
    async function cargarPermisos() {
        try {
            const response = await api.get('/permisos');
            console.log('üîë Respuesta permisos:', response.data);
            
            permisosDisponibles = response.data.data || response.data;
            
            if (!Array.isArray(permisosDisponibles)) {
                console.error('‚ùå Permisos no es un array');
                return;
            }
            
            console.log('‚úÖ Permisos cargados:', permisosDisponibles.length);
        } catch (error) {
            console.error('‚ùå Error cargando permisos:', error);
        }
    }

    // Renderizar permisos agrupados por m√≥dulo
    function renderizarPermisos() {
        const permisosPorModulo = {};
        
        permisosDisponibles.forEach(p => {
            const modulo = p.modulo || 'General';
            if (!permisosPorModulo[modulo]) {
                permisosPorModulo[modulo] = [];
            }
            permisosPorModulo[modulo].push(p);
        });

        permisosContainer.innerHTML = Object.keys(permisosPorModulo).sort().map(modulo => `
            <div style="margin-bottom: 20px; border: 1px solid #e5e7eb; border-radius: 8px; overflow: hidden;">
                <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 12px; font-weight: 600; font-size: 15px;">
                    üì¶ ${modulo}
                </div>
                <div style="padding: 10px; background: #f9fafb;">
                    ${permisosPorModulo[modulo].map(p => `
                        <label style="display: flex; align-items: start; gap: 10px; padding: 10px; cursor: pointer; border-radius: 4px; transition: all 0.2s; border-bottom: 1px solid #e5e7eb;"
                               onmouseover="this.style.background='#e0e7ff'" 
                               onmouseout="this.style.background='transparent'">
                            <input type="checkbox" 
                                   class="permiso-checkbox" 
                                   value="${p.id_permiso}" 
                                   ${permisosSeleccionados.includes(p.id_permiso) ? 'checked' : ''}
                                   style="margin-top: 2px; cursor: pointer; width: 18px; height: 18px;">
                            <div style="flex: 1;">
                                <div style="font-weight: 600; color: #1f2937;">${p.nombre}</div>
                                ${p.descripcion ? `<small style="color: #6b7280;">${p.descripcion}</small>` : ''}
                            </div>
                        </label>
                    `).join('')}
                </div>
            </div>
        `).join('');

        // Buscador de permisos
        document.getElementById('buscarPermiso').oninput = (e) => {
            const busqueda = e.target.value.toLowerCase();
            document.querySelectorAll('.permiso-checkbox').forEach(checkbox => {
                const label = checkbox.closest('label');
                const texto = label.textContent.toLowerCase();
                label.style.display = texto.includes(busqueda) ? 'flex' : 'none';
            });
        };
    }

    // Seleccionar/Deseleccionar todos
    document.getElementById('btnSeleccionarTodos').onclick = () => {
        document.querySelectorAll('.permiso-checkbox').forEach(cb => cb.checked = true);
    };

    document.getElementById('btnDeseleccionarTodos').onclick = () => {
        document.querySelectorAll('.permiso-checkbox').forEach(cb => cb.checked = false);
    };

    // Guardar permisos seleccionados
    document.getElementById('btnGuardarPermisos').onclick = () => {
        permisosSeleccionados = Array.from(document.querySelectorAll('.permiso-checkbox:checked'))
            .map(cb => parseInt(cb.value));
        
        console.log('‚úÖ Permisos individuales seleccionados:', permisosSeleccionados);
        alert(`‚úÖ ${permisosSeleccionados.length} permisos individuales seleccionados`);
        modalPermisos.style.display = 'none';
    };

    // Formatear fecha
    function formatearFecha(fecha) {
        if (!fecha) return 'Nunca';
        const date = new Date(fecha);
        const ahora = new Date();
        const diff = ahora - date;
        const minutos = Math.floor(diff / 60000);
        const horas = Math.floor(diff / 3600000);
        const dias = Math.floor(diff / 86400000);
        
        if (minutos < 1) return 'Hace un momento';
        if (minutos < 60) return `Hace ${minutos} min`;
        if (horas < 24) return `Hace ${horas} h`;
        if (dias < 7) return `Hace ${dias} d`;
        
        return date.toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit', year: 'numeric' });
    }

    // Cargar usuarios
    async function cargarUsuarios() {
        try {
            console.log('üë• Cargando usuarios...');
            
            const params = new URLSearchParams();
            const buscar = buscarUsuario.value.trim();
            const estado = filtroEstado.value;
            
            if (buscar) params.append('buscar', buscar);
            if (estado) params.append('estado', estado);
            
            const queryString = params.toString();
            const url = queryString ? `/usuarios?${queryString}` : '/usuarios';
            
            const response = await api.get(url);
            console.log('üë• Respuesta usuarios:', response.data);
            
            const usuarios = response.data.data || response.data;
            
            if (!Array.isArray(usuarios)) {
                console.error('‚ùå Usuarios no es un array');
                tabla.innerHTML = '<tr><td colspan="7" style="text-align:center; padding: 20px; color: red;">Error: Formato incorrecto</td></tr>';
                return;
            }
            
            console.log('‚úÖ Usuarios cargados:', usuarios.length);
            
            if (usuarios.length === 0) {
                tabla.innerHTML = '<tr><td colspan="7" style="text-align:center; padding: 20px; color: #666;">No se encontraron usuarios</td></tr>';
                return;
            }
            
            tabla.innerHTML = usuarios.map(u => {
                const roles = Array.isArray(u.roles) ? u.roles : [];
                const rolesText = roles.length > 0 
                    ? roles.map(r => `<span style="background: #dbeafe; color: #1e40af; padding: 2px 8px; border-radius: 12px; font-size: 12px; display: inline-block; margin: 2px;">${r.nombre}</span>`).join(' ')
                    : '<span style="color: #999;">Sin roles</span>';
                
                return `
                    <tr>
                        <td style="padding: 12px; border-bottom: 1px solid #e5e7eb;">${u.id_usuario}</td>
                        <td style="padding: 12px; border-bottom: 1px solid #e5e7eb;">${u.nombre || 'N/A'}</td>
                        <td style="padding: 12px; border-bottom: 1px solid #e5e7eb;">${u.email || 'N/A'}</td>
                        <td style="padding: 12px; border-bottom: 1px solid #e5e7eb;">${rolesText}</td>
                        <td style="padding: 12px; border-bottom: 1px solid #e5e7eb;">
                            ${u.bloqueado ? 
                                '<span style="background: #dc2626; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px;">üîí Bloqueado</span>' :
                                u.estado ?
                                '<span style="background: #10b981; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px;">‚úì Activo</span>' :
                                '<span style="background: #ef4444; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px;">‚úï Inactivo</span>'
                            }
                        </td>
                        <td style="padding: 12px; border-bottom: 1px solid #e5e7eb; font-size: 13px; color: #666;">${formatearFecha(u.ultimo_acceso)}</td>
                        <td style="padding: 12px; border-bottom: 1px solid #e5e7eb;">
                            <button class="btn-edit" data-id="${u.id_usuario}" style="background: #3b82f6; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; margin-right: 5px;">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn-delete" data-id="${u.id_usuario}" style="background: #ef4444; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer;">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');

            tabla.querySelectorAll('.btn-edit').forEach(btn => {
                btn.onclick = () => editarUsuario(btn.dataset.id);
            });
            tabla.querySelectorAll('.btn-delete').forEach(btn => {
                btn.onclick = () => eliminarUsuario(btn.dataset.id);
            });

        } catch (error) {
            console.error('‚ùå Error:', error);
            tabla.innerHTML = `<tr><td colspan="7" style="text-align:center; padding: 20px; color: red;">Error: ${error.response?.data?.message || error.message}</td></tr>`;
        }
    }

    // Filtros
    let timeoutBusqueda;
    buscarUsuario.addEventListener('input', () => {
        clearTimeout(timeoutBusqueda);
        timeoutBusqueda = setTimeout(cargarUsuarios, 500);
    });
    filtroEstado.addEventListener('change', cargarUsuarios);

    // Guardar usuario
    form.onsubmit = async (e) => {
        e.preventDefault();
        
        const formData = new FormData(form);
        const data = {
            nombre: formData.get('nombre'),
            email: formData.get('email'),
            estado: formData.get('estado') === 'true'
        };

        const password = formData.get('password');
        const idUsuario = formData.get('id_usuario');
        
        if (password && password.trim() !== '') {
            data.password = password;
        } else if (!idUsuario) {
            alert('‚ùå La contrase√±a es requerida');
            return;
        }

        // Roles seleccionados
        const rolesSeleccionados = [];
        form.querySelectorAll('input[name="roles[]"]:checked').forEach(cb => {
            rolesSeleccionados.push(parseInt(cb.value));
        });
        
        if (rolesSeleccionados.length > 0) {
            data.roles = rolesSeleccionados;
        }

        // Permisos individuales adicionales
        if (permisosSeleccionados.length > 0) {
            data.permisos = permisosSeleccionados;
        }

        console.log('üíæ Guardando usuario:', data);

        try {
            if (idUsuario) {
                await api.put(`/usuarios/${idUsuario}`, data);
                alert('‚úÖ Usuario actualizado correctamente');
            } else {
                await api.post('/usuarios', data);
                alert('‚úÖ Usuario creado correctamente');
            }
            
            modal.style.display = 'none';
            cargarUsuarios();
            
        } catch (error) {
            console.error('Error:', error);
            const errorMsg = error.response?.data?.message || error.message;
            const errorDetails = error.response?.data?.errors ? '\n' + error.response.data.errors.join('\n') : '';
            alert('‚ùå Error: ' + errorMsg + errorDetails);
        }
    };

    // Editar usuario
    async function editarUsuario(id) {
        try {
            const response = await api.get(`/usuarios/${id}`);
            const u = response.data.data || response.data;
            
            form.querySelector('[name="id_usuario"]').value = u.id_usuario;
            form.querySelector('[name="nombre"]').value = u.nombre;
            form.querySelector('[name="email"]').value = u.email;
            form.querySelector('[name="estado"]').value = u.estado.toString();
            
            passwordFields.style.display = 'block';
            inputPassword.required = false;
            inputPassword.value = '';
            inputPassword.placeholder = 'Dejar en blanco para mantener actual';
            
            // Marcar roles
            rolesCheckboxes.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
            if (Array.isArray(u.roles)) {
                u.roles.forEach(rol => {
                    const checkbox = rolesCheckboxes.querySelector(`input[value="${rol.id_rol}"]`);
                    if (checkbox) checkbox.checked = true;
                });
            }
            
            // Cargar permisos individuales del usuario
            if (Array.isArray(u.permisos)) {
                permisosSeleccionados = u.permisos.map(p => p.id_permiso);
            }
            
            document.getElementById('modalTitle').textContent = 'Editar Usuario';
            modal.style.display = 'flex';
            
        } catch (error) {
            console.error('Error:', error);
            alert('‚ùå Error al cargar usuario');
        }
    }

    // Eliminar usuario
    async function eliminarUsuario(id) {
        if (!confirm('¬øDesactivar este usuario?')) return;
        
        try {
            await api.delete(`/usuarios/${id}`);
            alert('‚úÖ Usuario desactivado');
            cargarUsuarios();
        } catch (error) {
            alert('‚ùå Error: ' + (error.response?.data?.message || error.message));
        }
    }

    // Inicializar
    await cargarRoles();
    await cargarPermisos();
    await cargarUsuarios();
    
    console.log('‚úÖ M√≥dulo de usuarios inicializado');
})();
</script>