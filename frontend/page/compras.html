<!-- compras.html - MEJORADO -->
<div class="compras-container" style="padding: 20px;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h1><i class="fas fa-file-invoice-dollar"></i> Gesti√≥n de Compras</h1>
        <button id="btnNuevaCompra" style="background: #3b82f6; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">
            <i class="fas fa-plus"></i> Nueva Compra
        </button>
    </div>

    <!-- Filtros -->
    <div style="background: white; padding: 15px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
            <select id="filtroProveedor" style="padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                <option value="">Todos los proveedores</option>
            </select>
            <select id="filtroEstado" style="padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                <option value="">Todos los estados</option>
                <option value="borrador">Borrador</option>
                <option value="pendiente">Pendiente</option>
                <option value="recibida">Recibida</option>
                <option value="facturada">Facturada</option>
                <option value="pagada">Pagada</option>
                <option value="cancelada">Cancelada</option>
            </select>
            <input type="date" id="filtroFechaDesde" placeholder="Fecha desde" style="padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
            <input type="date" id="filtroFechaHasta" placeholder="Fecha hasta" style="padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
            <input type="text" id="filtroNumeroFactura" placeholder="N√∫mero de factura..." style="padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
        </div>
    </div>

    <!-- Tabla -->
    <div style="background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
        <div style="overflow-x: auto;">
            <table id="tablaCompras" style="width: 100%; border-collapse: collapse; min-width: 1200px;">
                <thead style="background: #f3f4f6;">
                    <tr>
                        <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e5e7eb;">N¬∞ Compra</th>
                        <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e5e7eb;">Fecha</th>
                        <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e5e7eb;">Proveedor</th>
                        <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e5e7eb;">N¬∞ Factura</th>
                        <th style="padding: 12px; text-align: right; border-bottom: 2px solid #e5e7eb;">Total</th>
                        <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e5e7eb;">Estado</th>
                        <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e5e7eb;">Usuario</th>
                        <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e5e7eb;">Acciones</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

    <!-- Modal Nueva/Editar Compra -->
    <div id="modalCompra" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); justify-content: center; align-items: center; z-index: 1000; overflow-y: auto;">
        <div style="background: white; padding: 30px; border-radius: 10px; width: 95%; max-width: 1200px; max-height: 90vh; overflow-y: auto; margin: 20px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2 id="modalTitle">Nueva Orden de Compra</h2>
                <button id="btnCerrarModal" style="background: none; border: none; font-size: 28px; cursor: pointer; color: #666;">&times;</button>
            </div>
            
            <form id="formCompra">
                <input type="hidden" name="id_compra">
                
                <!-- Informaci√≥n General -->
                <div style="background: #f9fafb; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                    <h3 style="margin: 0 0 15px 0; color: #374151;"><i class="fas fa-info-circle"></i> Informaci√≥n General</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-weight: 600;">Proveedor:</label>
                            <select name="id_proveedor" id="selectProveedor" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                                <option value="">Sin proveedor (Compra directa)</option>
                            </select>
                        </div>
                        
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-weight: 600;">Almac√©n Destino: <span style="color: red;">*</span></label>
                            <select name="id_almacen" id="selectAlmacen" required style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                                <option value="">Seleccionar almac√©n</option>
                            </select>
                        </div>
                        
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-weight: 600;">Forma de Pago:</label>
                            <select name="forma_pago" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                                <option value="">Seleccionar...</option>
                                <option value="Efectivo">Efectivo</option>
                                <option value="Transferencia">Transferencia</option>
                                <option value="Cheque">Cheque</option>
                                <option value="Tarjeta">Tarjeta</option>
                            </select>
                        </div>
                        
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-weight: 600;">Condici√≥n de Pago:</label>
                            <select name="condicion_pago" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                                <option value="">Seleccionar...</option>
                                <option value="Contado">Contado</option>
                                <option value="15 d√≠as">15 d√≠as</option>
                                <option value="30 d√≠as">30 d√≠as</option>
                                <option value="45 d√≠as">45 d√≠as</option>
                                <option value="60 d√≠as">60 d√≠as</option>
                                <option value="90 d√≠as">90 d√≠as</option>
                            </select>
                        </div>
                        
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-weight: 600;">Estado:</label>
                            <select name="estado" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                                <option value="borrador">Borrador</option>
                                <option value="pendiente">Pendiente</option>
                                <option value="recibida">Recibida</option>
                            </select>
                            <small style="color: #666; font-size: 0.85rem;">Cambie a "Recibida" para actualizar inventario</small>
                        </div>
                    </div>
                </div>

                <!-- Facturaci√≥n -->
                <div style="background: #f9fafb; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                    <h3 style="margin: 0 0 15px 0; color: #374151;"><i class="fas fa-file-invoice"></i> Informaci√≥n de Factura</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-weight: 600;">N√∫mero de Factura:</label>
                            <input type="text" name="numero_factura" placeholder="FAC-2025-00123" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                        </div>
                        
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-weight: 600;">Serie:</label>
                            <input type="text" name="serie_factura" placeholder="A001" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                        </div>
                        
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-weight: 600;">Fecha Factura:</label>
                            <input type="date" name="fecha_factura" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                        </div>
                    </div>
                </div>

                <!-- Productos/Ingredientes -->
                <div style="background: #f9fafb; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h3 style="margin: 0; color: #374151;"><i class="fas fa-boxes"></i> Ingredientes</h3>
                        <button type="button" id="btnAgregarProducto" style="background: #10b981; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer;">
                            <i class="fas fa-plus"></i> Agregar Ingrediente
                        </button>
                    </div>
                    
                    <div style="overflow-x: auto;">
                        <table id="tablaDetalles" style="width: 100%; border-collapse: collapse; min-width: 900px;">
                            <thead style="background: #e5e7eb;">
                                <tr>
                                    <th style="padding: 10px; text-align: left; border: 1px solid #d1d5db;">Ingrediente</th>
                                    <th style="padding: 10px; text-align: center; border: 1px solid #d1d5db; width: 100px;">Cantidad</th>
                                    <th style="padding: 10px; text-align: right; border: 1px solid #d1d5db; width: 120px;">Costo Unit.</th>
                                    <th style="padding: 10px; text-align: center; border: 1px solid #d1d5db; width: 100px;">Desc. %</th>
                                    <th style="padding: 10px; text-align: right; border: 1px solid #d1d5db; width: 120px;">Desc. Bs.</th>
                                    <th style="padding: 10px; text-align: right; border: 1px solid #d1d5db; width: 130px;">Subtotal</th>
                                    <th style="padding: 10px; text-align: center; border: 1px solid #d1d5db; width: 80px;">Acci√≥n</th>
                                </tr>
                            </thead>
                            <tbody id="detallesBody"></tbody>
                        </table>
                    </div>
                    
                    <div id="mensajeProductos" style="text-align: center; padding: 30px; color: #9ca3af; display: none;">
                        <i class="fas fa-box-open" style="font-size: 3rem; margin-bottom: 10px; opacity: 0.5;"></i>
                        <p>No hay ingredientes agregados. Haz clic en "Agregar Ingrediente"</p>
                    </div>
                </div>

                <!-- Totales y Observaciones -->
                <div style="background: #f9fafb; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                    <div style="display: grid; grid-template-columns: 1fr 350px; gap: 20px; align-items: start;">
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-weight: 600;">Observaciones:</label>
                            <textarea name="observaciones" rows="6" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; box-sizing: border-box;"></textarea>
                        </div>
                        
                        <div>
                            <div style="background: white; padding: 15px; border-radius: 8px; border: 1px solid #e5e7eb;">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 8px; color: #666;">
                                    <span>Subtotal Exento:</span>
                                    <span id="subtotalExentoDisplay">Bs. 0.00</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; margin-bottom: 8px; color: #666;">
                                    <span>Subtotal Gravado:</span>
                                    <span id="subtotalGravadoDisplay">Bs. 0.00</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; margin-bottom: 8px; font-weight: 600;">
                                    <span>Subtotal:</span>
                                    <span id="subtotalDisplay">Bs. 0.00</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; margin-bottom: 8px; color: #10b981; font-weight: 600;">
                                    <span>IVA (13%):</span>
                                    <span id="ivaDisplay">Bs. 0.00</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                    <label>Impuestos Adicionales:</label>
                                    <input type="number" name="impuestos_adicionales" id="impuestosAdicionalesInput" step="0.01" min="0" value="0" style="width: 120px; padding: 5px; border: 1px solid #ddd; border-radius: 5px; text-align: right;">
                                </div>
                                <div style="border-top: 2px solid #e5e7eb; padding-top: 10px; margin-top: 10px;">
                                    <div style="display: flex; justify-content: space-between; font-size: 1.25rem;">
                                        <strong>Total:</strong>
                                        <strong id="totalDisplay" style="color: #3b82f6;">Bs. 0.00</strong>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <button type="submit" style="width: 100%; background: #10b981; color: white; border: none; padding: 12px; border-radius: 5px; cursor: pointer; font-size: 16px; font-weight: 600;">
                    <i class="fas fa-save"></i> Guardar Compra
                </button>
            </form>
        </div>
    </div>

    <!-- Modal Ver Detalle -->
    <div id="modalDetalle" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); justify-content: center; align-items: center; z-index: 1000;">
        <div style="background: white; padding: 30px; border-radius: 10px; width: 90%; max-width: 1000px; max-height: 90vh; overflow-y: auto;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2><i class="fas fa-file-invoice"></i> Detalle de Compra</h2>
                <button id="btnCerrarDetalle" style="background: none; border: none; font-size: 28px; cursor: pointer; color: #666;">&times;</button>
            </div>
            <div id="contenidoDetalle"></div>
        </div>
    </div>
</div>

<script>
(async function() {
    console.log('üöÄ Inicializando m√≥dulo de compras mejorado...');
    
    const api = window.api;
    if (!api) {
        console.error('‚ùå API no est√° disponible');
        return;
    }
    
    const token = localStorage.getItem('token') || sessionStorage.getItem('token');
    if (token) {
        api.defaults.headers.common['Authorization'] = `Bearer ${token}`;
    } else {
        alert('‚ö†Ô∏è No hay sesi√≥n activa');
        window.location.href = '/frontend/page/login.html';
        return;
    }
    
    // Referencias DOM
    const tabla = document.querySelector('#tablaCompras tbody');
    const modal = document.getElementById('modalCompra');
    const modalDetalle = document.getElementById('modalDetalle');
    const form = document.getElementById('formCompra');
    const btnNueva = document.getElementById('btnNuevaCompra');
    const btnCerrar = document.getElementById('btnCerrarModal');
    const btnCerrarDetalle = document.getElementById('btnCerrarDetalle');
    const detallesBody = document.getElementById('detallesBody');
    const btnAgregarProducto = document.getElementById('btnAgregarProducto');
    const mensajeProductos = document.getElementById('mensajeProductos');
    const impuestosAdicionalesInput = document.getElementById('impuestosAdicionalesInput');

    let detallesCompra = [];
    let ingredientes = [];
    let proveedores = [];
    let almacenes = [];

    // ============================================
    // MODAL - ABRIR/CERRAR
    // ============================================
    
    btnNueva.onclick = () => {
        form.reset();
        detallesCompra = [];
        renderizarDetalles();
        calcularTotales();
        document.getElementById('modalTitle').textContent = 'Nueva Orden de Compra';
        modal.style.display = 'flex';
    };

    btnCerrar.onclick = () => modal.style.display = 'none';
    modal.onclick = (e) => {
        if (e.target === modal) modal.style.display = 'none';
    };

    btnCerrarDetalle.onclick = () => modalDetalle.style.display = 'none';
    modalDetalle.onclick = (e) => {
        if (e.target === modalDetalle) modalDetalle.style.display = 'none';
    };

    // ============================================
    // CARGAR DATOS INICIALES
    // ============================================
    
    async function cargarDatosIniciales() {
        try {
            const [ingRes, provRes, almRes] = await Promise.all([
                api.get('/ingredientes?estado=true'),
                api.get('/proveedores?estado=true'),
                api.get('/almacenes?estado=true')
            ]);

            ingredientes = ingRes.data.data || ingRes.data;
            proveedores = provRes.data.data || provRes.data;
            almacenes = almRes.data.data || almRes.data;

            const selectProveedor = document.getElementById('selectProveedor');
            const filtroProveedor = document.getElementById('filtroProveedor');
            const optionsProveedor = proveedores.map(p => 
                `<option value="${p.id_proveedor}">${p.nombre}</option>`
            ).join('');
            selectProveedor.innerHTML += optionsProveedor;
            filtroProveedor.innerHTML += optionsProveedor;

            const selectAlmacen = document.getElementById('selectAlmacen');
            selectAlmacen.innerHTML += almacenes.map(a => 
                `<option value="${a.id_almacen}">${a.nombre}</option>`
            ).join('');

            console.log('‚úÖ Datos iniciales cargados');
        } catch (error) {
            console.error('‚ùå Error cargando datos:', error);
        }
    }

    // ============================================
    // GESTI√ìN DE DETALLES (INGREDIENTES)
    // ============================================
    
    btnAgregarProducto.onclick = () => {
        const fila = {
            id_ingrediente: '',
            cantidad: 1,
            costo_unitario: 0,
            descuento_porcentaje: 0,
            descuento_monto: 0
        };
        detallesCompra.push(fila);
        renderizarDetalles();
    };

    function renderizarDetalles() {
        if (detallesCompra.length === 0) {
            detallesBody.innerHTML = '';
            mensajeProductos.style.display = 'block';
            return;
        }

        mensajeProductos.style.display = 'none';
        
        detallesBody.innerHTML = detallesCompra.map((detalle, index) => {
            const subtotalBruto = (detalle.cantidad || 0) * (detalle.costo_unitario || 0);
            const descuento = detalle.descuento_porcentaje 
                ? (subtotalBruto * detalle.descuento_porcentaje / 100)
                : (detalle.descuento_monto || 0);
            const subtotal = subtotalBruto - descuento;
            
            return `
                <tr>
                    <td style="padding: 8px; border: 1px solid #d1d5db;">
                        <select class="ingrediente-select" data-index="${index}" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            <option value="">Seleccionar ingrediente</option>
                            ${ingredientes.map(i => 
                                `<option value="${i.id_ingrediente}" ${i.id_ingrediente == detalle.id_ingrediente ? 'selected' : ''}>
                                    ${i.codigo} - ${i.nombre} (${i.unidad_medida})
                                </option>`
                            ).join('')}
                        </select>
                    </td>
                    <td style="padding: 8px; border: 1px solid #d1d5db;">
                        <input type="number" class="cantidad-input" data-index="${index}" value="${detalle.cantidad}" min="0.01" step="0.01" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; text-align: center;">
                    </td>
                    <td style="padding: 8px; border: 1px solid #d1d5db;">
                        <input type="number" class="costo-input" data-index="${index}" value="${detalle.costo_unitario}" min="0" step="0.01" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; text-align: right;">
                    </td>
                    <td style="padding: 8px; border: 1px solid #d1d5db;">
                        <input type="number" class="descuento-porcentaje-input" data-index="${index}" value="${detalle.descuento_porcentaje}" min="0" max="100" step="0.01" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; text-align: center;">
                    </td>
                    <td style="padding: 8px; border: 1px solid #d1d5db;">
                        <input type="number" class="descuento-monto-input" data-index="${index}" value="${detalle.descuento_monto}" min="0" step="0.01" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; text-align: right;">
                    </td>
                    <td style="padding: 8px; border: 1px solid #d1d5db; text-align: right; font-weight: 600;">
                        Bs. ${subtotal.toFixed(2)}
                    </td>
                    <td style="padding: 8px; border: 1px solid #d1d5db; text-align: center;">
                        <button type="button" class="btn-eliminar-detalle" data-index="${index}" style="background: #ef4444; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer;">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `;
        }).join('');

        // Event listeners
        document.querySelectorAll('.ingrediente-select').forEach(select => {
            select.onchange = function() {
                detallesCompra[this.dataset.index].id_ingrediente = this.value;
                calcularTotales();
            };
        });

        document.querySelectorAll('.cantidad-input').forEach(input => {
            input.oninput = function() {
                detallesCompra[this.dataset.index].cantidad = parseFloat(this.value) || 0;
                calcularTotales();
                renderizarDetalles();
            };
        });

        document.querySelectorAll('.costo-input').forEach(input => {
            input.oninput = function() {
                detallesCompra[this.dataset.index].costo_unitario = parseFloat(this.value) || 0;
                calcularTotales();
                renderizarDetalles();
            };
        });

        document.querySelectorAll('.descuento-porcentaje-input').forEach(input => {
            input.oninput = function() {
                const index = this.dataset.index;
                detallesCompra[index].descuento_porcentaje = parseFloat(this.value) || 0;
                detallesCompra[index].descuento_monto = 0; // Reset monto si se usa porcentaje
                calcularTotales();
                renderizarDetalles();
            };
        });

        document.querySelectorAll('.descuento-monto-input').forEach(input => {
            input.oninput = function() {
                const index = this.dataset.index;
                detallesCompra[index].descuento_monto = parseFloat(this.value) || 0;
                detallesCompra[index].descuento_porcentaje = 0; // Reset porcentaje si se usa monto
                calcularTotales();
                renderizarDetalles();
            };
        });

        document.querySelectorAll('.btn-eliminar-detalle').forEach(btn => {
            btn.onclick = function() {
                detallesCompra.splice(this.dataset.index, 1);
                renderizarDetalles();
                calcularTotales();
            };
        });
    }

    function calcularTotales() {
        let subtotal = 0;
        let subtotalExento = 0;
        let subtotalGravado = 0;

        detallesCompra.forEach(d => {
            const subtotalBruto = (d.cantidad || 0) * (d.costo_unitario || 0);
            const descuento = d.descuento_porcentaje 
                ? (subtotalBruto * d.descuento_porcentaje / 100)
                : (d.descuento_monto || 0);
            const subtotalDetalle = subtotalBruto - descuento;
            
            subtotal += subtotalDetalle;
            subtotalGravado += subtotalDetalle; // Por ahora todos est√°n gravados
        });

        const iva = subtotalGravado * 0.13;
        const impuestosAdicionales = parseFloat(impuestosAdicionalesInput.value) || 0;
        const total = subtotal + iva + impuestosAdicionales;

        document.getElementById('subtotalExentoDisplay').textContent = `Bs. ${subtotalExento.toFixed(2)}`;
        document.getElementById('subtotalGravadoDisplay').textContent = `Bs. ${subtotalGravado.toFixed(2)}`;
        document.getElementById('subtotalDisplay').textContent = `Bs. ${subtotal.toFixed(2)}`;
        document.getElementById('ivaDisplay').textContent = `Bs. ${iva.toFixed(2)}`;
        document.getElementById('totalDisplay').textContent = `Bs. ${total.toFixed(2)}`;
    }

    impuestosAdicionalesInput.oninput = calcularTotales;

    // ============================================
    // CARGAR COMPRAS
    // ============================================
    
    async function cargarCompras() {
        try {
            const params = new URLSearchParams();
            
            const proveedor = document.getElementById('filtroProveedor').value;
            const estado = document.getElementById('filtroEstado').value;
            const fechaDesde = document.getElementById('filtroFechaDesde').value;
            const fechaHasta = document.getElementById('filtroFechaHasta').value;
            const numeroFactura = document.getElementById('filtroNumeroFactura').value;
            
            if (proveedor) params.append('id_proveedor', proveedor);
            if (estado) params.append('estado', estado);
            if (fechaDesde) params.append('fecha_desde', fechaDesde);
            if (fechaHasta) params.append('fecha_hasta', fechaHasta);
            if (numeroFactura) params.append('numero_factura', numeroFactura);
            
            const queryString = params.toString();
            const url = queryString ? `/compras?${queryString}` : '/compras';
            
            const response = await api.get(url);
            const compras = response.data.data || response.data;
            
            if (compras.length === 0) {
                tabla.innerHTML = '<tr><td colspan="8" style="text-align:center; padding: 20px; color: #666;">No se encontraron compras</td></tr>';
                return;
            }
            
            tabla.innerHTML = compras.map(c => {
                const estadoConfig = {
                    'borrador': { color: '#9ca3af', icon: 'file' },
                    'pendiente': { color: '#f59e0b', icon: 'clock' },
                    'recibida': { color: '#10b981', icon: 'check-circle' },
                    'facturada': { color: '#3b82f6', icon: 'file-invoice' },
                    'pagada': { color: '#8b5cf6', icon: 'check-double' },
                    'cancelada': { color: '#ef4444', icon: 'times-circle' }
                };
                
                const config = estadoConfig[c.estado] || { color: '#9ca3af', icon: 'question' };
                
                return `
                    <tr>
                        <td style="padding: 12px; border-bottom: 1px solid #e5e7eb; font-weight: 600;">${c.numero_compra}</td>
                        <td style="padding: 12px; border-bottom: 1px solid #e5e7eb;">${new Date(c.fecha_compra).toLocaleDateString('es-ES')}</td>
                        <td style="padding: 12px; border-bottom: 1px solid #e5e7eb;">${c.proveedor_nombre || 'Compra directa'}</td>
                        <td style="padding: 12px; border-bottom: 1px solid #e5e7eb;">${c.numero_factura || '-'}</td>
                        <td style="padding: 12px; border-bottom: 1px solid #e5e7eb; text-align: right; font-weight: 600; color: #10b981;">Bs. ${parseFloat(c.total).toFixed(2)}</td>
                        <td style="padding: 12px; border-bottom: 1px solid #e5e7eb;">
                            <span style="background: ${config.color}; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px; text-transform: capitalize;">
                                <i class="fas fa-${config.icon}"></i> ${c.estado}
                            </span>
                        </td>
                        <td style="padding: 12px; border-bottom: 1px solid #e5e7eb;">${c.usuario_nombre || 'N/A'}</td>
                        <td style="padding: 12px; border-bottom: 1px solid #e5e7eb;">
                            <button class="btn-ver" data-id="${c.id_compra}" style="background: #8b5cf6; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; margin-right: 5px;" title="Ver detalle">
                                <i class="fas fa-eye"></i>
                            </button>
                            ${c.estado === 'borrador' || c.estado === 'pendiente' ? `
                                <button class="btn-recibir" data-id="${c.id_compra}" style="background: #10b981; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; margin-right: 5px;" title="Marcar como recibida">
                                    <i class="fas fa-check"></i>
                                </button>
                            ` : ''}
                            ${c.estado === 'recibida' && c.numero_factura ? `
                                <button class="btn-facturar" data-id="${c.id_compra}" style="background: #3b82f6; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; margin-right: 5px;" title="Marcar como facturada">
                                    <i class="fas fa-file-invoice"></i>
                                </button>
                            ` : ''}
                            ${c.estado === 'facturada' ? `
                                <button class="btn-pagar" data-id="${c.id_compra}" style="background: #8b5cf6; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; margin-right: 5px;" title="Marcar como pagada">
                                    <i class="fas fa-dollar-sign"></i>
                                </button>
                            ` : ''}
                            ${c.estado === 'borrador' || c.estado === 'pendiente' ? `
                                <button class="btn-cancelar" data-id="${c.id_compra}" style="background: #ef4444; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer;" title="Cancelar">
                                    <i class="fas fa-times"></i>
                                </button>
                            ` : ''}
                        </td>
                    </tr>
                `;
            }).join('');

            // Event listeners
            tabla.querySelectorAll('.btn-ver').forEach(btn => {
                btn.onclick = () => verDetalle(btn.dataset.id);
            });
            tabla.querySelectorAll('.btn-recibir').forEach(btn => {
                btn.onclick = () => cambiarEstado(btn.dataset.id, 'recibida');
            });
            tabla.querySelectorAll('.btn-facturar').forEach(btn => {
                btn.onclick = () => cambiarEstado(btn.dataset.id, 'facturada');
            });
            tabla.querySelectorAll('.btn-pagar').forEach(btn => {
                btn.onclick = () => cambiarEstado(btn.dataset.id, 'pagada');
            });
            tabla.querySelectorAll('.btn-cancelar').forEach(btn => {
                btn.onclick = () => cancelarCompra(btn.dataset.id);
            });

        } catch (error) {
            console.error('‚ùå Error al cargar compras:', error);
            tabla.innerHTML = `<tr><td colspan="8" style="text-align:center; padding: 20px; color: red;">Error al cargar compras</td></tr>`;
        }
    }

    // ============================================
    // EVENTOS DE FILTROS
    // ============================================
    
    document.getElementById('filtroProveedor').addEventListener('change', cargarCompras);
    document.getElementById('filtroEstado').addEventListener('change', cargarCompras);
    document.getElementById('filtroFechaDesde').addEventListener('change', cargarCompras);
    document.getElementById('filtroFechaHasta').addEventListener('change', cargarCompras);
    document.getElementById('filtroNumeroFactura').addEventListener('input', () => {
        clearTimeout(window.filtroFacturaTimeout);
        window.filtroFacturaTimeout = setTimeout(cargarCompras, 500);
    });

    // ============================================
    // GUARDAR COMPRA
    // ============================================
    
    form.onsubmit = async (e) => {
        e.preventDefault();
        
        if (detallesCompra.length === 0) {
            alert('‚ùå Debe agregar al menos un ingrediente');
            return;
        }

        const invalidos = detallesCompra.filter(d => 
            !d.id_ingrediente || d.cantidad <= 0 || d.costo_unitario <= 0
        );
        
        if (invalidos.length > 0) {
            alert('‚ùå Todos los ingredientes deben tener: ingrediente seleccionado, cantidad y costo v√°lidos');
            return;
        }

        const formData = new FormData(form);
        const idProveedor = formData.get('id_proveedor');
        const idAlmacen = formData.get('id_almacen');
        
        if (!idAlmacen || idAlmacen === '') {
            alert('‚ùå Debe seleccionar un almac√©n destino');
            return;
        }
        
        const data = {
            id_proveedor: (idProveedor && idProveedor !== '') ? parseInt(idProveedor) : null,
            id_almacen: parseInt(idAlmacen),
            impuestos_adicionales: parseFloat(formData.get('impuestos_adicionales')) || 0,
            observaciones: formData.get('observaciones') || null,
            estado: formData.get('estado'),
            numero_factura: formData.get('numero_factura') || null,
            fecha_factura: formData.get('fecha_factura') || null,
            serie_factura: formData.get('serie_factura') || null,
            forma_pago: formData.get('forma_pago') || null,
            condicion_pago: formData.get('condicion_pago') || null,
            detalles: detallesCompra.map(d => ({
                id_ingrediente: parseInt(d.id_ingrediente),
                cantidad: parseFloat(d.cantidad),
                costo_unitario: parseFloat(d.costo_unitario),
                descuento_porcentaje: parseFloat(d.descuento_porcentaje) || null,
                descuento_monto: parseFloat(d.descuento_monto) || null
            }))
        };

        console.log('üì§ Datos a enviar:', data);

        try {
            const response = await api.post('/compras', data);
            console.log('‚úÖ Respuesta del servidor:', response.data);
            alert('‚úÖ ' + response.data.message);
            modal.style.display = 'none';
            form.reset();
            detallesCompra = [];
            cargarCompras();
        } catch (error) {
            console.error('‚ùå Error completo:', error);
            console.error('‚ùå Respuesta del servidor:', error.response?.data);
            alert('‚ùå Error al guardar compra: ' + (error.response?.data?.message || error.message));
        }
    };

    // ============================================
    // VER DETALLE
    // ============================================
    
    async function verDetalle(id) {
        try {
            const response = await api.get(`/compras/${id}`);
            const compra = response.data.data || response.data;
            
            const estadoConfig = {
                'borrador': { color: '#9ca3af', icon: 'file' },
                'pendiente': { color: '#f59e0b', icon: 'clock' },
                'recibida': { color: '#10b981', icon: 'check-circle' },
                'facturada': { color: '#3b82f6', icon: 'file-invoice' },
                'pagada': { color: '#8b5cf6', icon: 'check-double' },
                'cancelada': { color: '#ef4444', icon: 'times-circle' }
            };
            
            const config = estadoConfig[compra.estado] || { color: '#9ca3af', icon: 'question' };
            
            const contenido = document.getElementById('contenidoDetalle');
            contenido.innerHTML = `
                <!-- Informaci√≥n General -->
                <div style="background: #f9fafb; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                    <h3 style="margin: 0 0 15px 0; color: #374151;">Informaci√≥n General</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                        <div>
                            <strong>N¬∞ Compra:</strong><br>${compra.numero_compra}
                        </div>
                        <div>
                            <strong>Fecha Compra:</strong><br>${new Date(compra.fecha_compra).toLocaleDateString('es-ES')}
                        </div>
                        <div>
                            <strong>Proveedor:</strong><br>${compra.proveedor_nombre || 'Compra directa'}
                            ${compra.proveedor_nit ? `<br><small>NIT: ${compra.proveedor_nit}</small>` : ''}
                        </div>
                        <div>
                            <strong>Almac√©n:</strong><br>${compra.almacen_nombre || 'N/A'}
                        </div>
                        <div>
                            <strong>Estado:</strong><br>
                            <span style="background: ${config.color}; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px;">
                                <i class="fas fa-${config.icon}"></i> ${compra.estado}
                            </span>
                        </div>
                        <div>
                            <strong>Forma de Pago:</strong><br>${compra.forma_pago || '-'}
                        </div>
                        <div>
                            <strong>Condici√≥n:</strong><br>${compra.condicion_pago || '-'}
                        </div>
                        <div>
                            <strong>Creado por:</strong><br>${compra.usuario_nombre || 'N/A'}
                        </div>
                    </div>
                </div>

                ${compra.numero_factura ? `
                <div style="background: #f9fafb; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                    <h3 style="margin: 0 0 15px 0; color: #374151;">Informaci√≥n de Factura</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                        <div>
                            <strong>N¬∞ Factura:</strong><br>${compra.numero_factura}
                        </div>
                        ${compra.serie_factura ? `
                        <div>
                            <strong>Serie:</strong><br>${compra.serie_factura}
                        </div>
                        ` : ''}
                        ${compra.fecha_factura ? `
                        <div>
                            <strong>Fecha Factura:</strong><br>${new Date(compra.fecha_factura).toLocaleDateString('es-ES')}
                        </div>
                        ` : ''}
                    </div>
                </div>
                ` : ''}

                ${compra.fecha_recepcion ? `
                <div style="background: #f9fafb; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                    <h3 style="margin: 0 0 15px 0; color: #374151;">Informaci√≥n de Recepci√≥n</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                        <div>
                            <strong>Fecha Recepci√≥n:</strong><br>${new Date(compra.fecha_recepcion).toLocaleString('es-ES')}
                        </div>
                        <div>
                            <strong>Recibido por:</strong><br>${compra.recibido_por_nombre || 'N/A'}
                        </div>
                    </div>
                </div>
                ` : ''}

                <!-- Ingredientes -->
                <h3 style="margin: 20px 0 10px 0;">Ingredientes</h3>
                <table style="width: 100%; border-collapse: collapse; margin-bottom: 20px;">
                    <thead style="background: #f3f4f6;">
                        <tr>
                            <th style="padding: 10px; text-align: left; border: 1px solid #e5e7eb;">Ingrediente</th>
                            <th style="padding: 10px; text-align: center; border: 1px solid #e5e7eb;">Cantidad</th>
                            <th style="padding: 10px; text-align: right; border: 1px solid #e5e7eb;">Costo Unit.</th>
                            <th style="padding: 10px; text-align: right; border: 1px solid #e5e7eb;">Descuento</th>
                            <th style="padding: 10px; text-align: right; border: 1px solid #e5e7eb;">Subtotal</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${compra.detalles.map(d => {
                            const descuento = d.descuento_porcentaje 
                                ? `${d.descuento_porcentaje}%`
                                : d.descuento_monto 
                                    ? `Bs. ${parseFloat(d.descuento_monto).toFixed(2)}`
                                    : '-';
                            
                            return `
                            <tr>
                                <td style="padding: 10px; border: 1px solid #e5e7eb;">${d.ingrediente_codigo} - ${d.ingrediente_nombre}</td>
                                <td style="padding: 10px; text-align: center; border: 1px solid #e5e7eb;">${d.cantidad} ${d.unidad_medida}</td>
                                <td style="padding: 10px; text-align: right; border: 1px solid #e5e7eb;">Bs. ${parseFloat(d.costo_unitario).toFixed(2)}</td>
                                <td style="padding: 10px; text-align: right; border: 1px solid #e5e7eb;">${descuento}</td>
                                <td style="padding: 10px; text-align: right; border: 1px solid #e5e7eb; font-weight: 600;">Bs. ${parseFloat(d.subtotal).toFixed(2)}</td>
                            </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>

                <!-- Totales -->
                <div style="background: #f9fafb; padding: 15px; border-radius: 8px;">
                    <div style="display: flex; justify-content: flex-end;">
                        <div style="min-width: 350px;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 8px; color: #666;">
                                <span>Subtotal Exento:</span>
                                <span>Bs. ${parseFloat(compra.subtotal_exento || 0).toFixed(2)}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 8px; color: #666;">
                                <span>Subtotal Gravado:</span>
                                <span>Bs. ${parseFloat(compra.subtotal_gravado || 0).toFixed(2)}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 8px; font-weight: 600;">
                                <span>Subtotal:</span>
                                <span>Bs. ${parseFloat(compra.subtotal).toFixed(2)}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 8px; color: #10b981; font-weight: 600;">
                                <span>IVA (13%):</span>
                                <span>Bs. ${parseFloat(compra.iva || 0).toFixed(2)}</span>
                            </div>
                            ${compra.impuestos > 0 ? `
                            <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                                <span>Impuestos Adicionales:</span>
                                <strong>Bs. ${parseFloat(compra.impuestos).toFixed(2)}</strong>
                            </div>
                            ` : ''}
                            <div style="border-top: 2px solid #e5e7eb; padding-top: 10px; margin-top: 10px;">
                                <div style="display: flex; justify-content: space-between; font-size: 1.25rem;">
                                    <strong>Total:</strong>
                                    <strong style="color: #10b981;">Bs. ${parseFloat(compra.total).toFixed(2)}</strong>
                                </div>
                            </div>
                        </div>
                    </div>
                    ${compra.observaciones ? `
                        <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #e5e7eb;">
                            <strong>Observaciones:</strong><br>
                            <p style="margin: 5px 0; color: #666;">${compra.observaciones}</p>
                        </div>
                    ` : ''}
                </div>
            `;
            
            modalDetalle.style.display = 'flex';
        } catch (error) {
            console.error('Error:', error);
            alert('‚ùå Error al cargar detalle');
        }
    }

    // ============================================
    // CAMBIAR ESTADO
    // ============================================
    
    async function cambiarEstado(id, nuevoEstado) {
        const mensajes = {
            'recibida': '¬øMarcar esta compra como recibida? Se actualizar√° el inventario autom√°ticamente.',
            'facturada': '¬øMarcar como facturada? Aseg√∫rese de haber registrado el n√∫mero de factura.',
            'pagada': '¬øMarcar como pagada? Esta acci√≥n indica que la compra ha sido completamente pagada.'
        };
        
        if (!confirm(mensajes[nuevoEstado] || '¬øCambiar el estado de esta compra?')) return;
        
        try {
            await api.patch(`/compras/${id}/estado`, { estado: nuevoEstado });
            alert(`‚úÖ Estado actualizado a: ${nuevoEstado}`);
            cargarCompras();
        } catch (error) {
            console.error('Error:', error);
            alert('‚ùå Error al cambiar estado: ' + (error.response?.data?.message || error.message));
        }
    }

    // ============================================
    // CANCELAR COMPRA
    // ============================================
    
    async function cancelarCompra(id) {
        if (!confirm('¬øEst√° seguro de cancelar esta compra?\n\nNOTA: Solo se pueden cancelar compras en estado borrador o pendiente.')) {
            return;
        }
        
        try {
            await api.delete(`/compras/${id}`);
            alert('‚úÖ Compra cancelada correctamente');
            cargarCompras();
        } catch (error) {
            console.error('Error:', error);
            alert('‚ùå Error al cancelar compra: ' + (error.response?.data?.message || error.message));
        }
    }

    // ============================================
    // INICIALIZAR
    // ============================================
    
    await cargarDatosIniciales();
    await cargarCompras();
    
    console.log('‚úÖ M√≥dulo de compras mejorado inicializado correctamente');
})();
</script>