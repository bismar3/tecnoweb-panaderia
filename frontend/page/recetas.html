<!-- recetas.html - SIN <html>, <head>, solo contenido -->
<div class="recetas-container" style="padding: 20px;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h1><i class="fas fa-book"></i> Gesti√≥n de Recetas</h1>
        <button id="btnNuevaReceta" style="background: #3b82f6; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">
            <i class="fas fa-plus"></i> Nueva Receta
        </button>
    </div>

    <!-- Filtros -->
    <div style="background: white; padding: 15px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
            <input type="text" id="buscarReceta" placeholder="Buscar receta..." style="padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
            <select id="filtroProducto" style="padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                <option value="">Todos los productos</option>
            </select>
            <select id="filtroEstado" style="padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                <option value="">Todos los estados</option>
                <option value="true">Activo</option>
                <option value="false">Inactivo</option>
            </select>
        </div>
    </div>

    <!-- Tabla -->
    <div style="background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
        <table id="tablaRecetas" style="width: 100%; border-collapse: collapse;">
            <thead style="background: #f3f4f6;">
                <tr>
                    <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e5e7eb;">Nombre</th>
                    <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e5e7eb;">Producto Base</th>
                    <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e5e7eb;">Rendimiento</th>
                    <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e5e7eb;">Tiempo</th>
                    <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e5e7eb;">Ingredientes</th>
                    <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e5e7eb;">Estado</th>
                    <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e5e7eb;">Acciones</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <!-- Modal Crear/Editar -->
    <div id="modalReceta" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); justify-content: center; align-items: center; z-index: 1000; overflow-y: auto;">
        <div style="background: white; padding: 30px; border-radius: 10px; width: 90%; max-width: 700px; max-height: 90vh; overflow-y: auto; margin: 20px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2 id="modalTitle"><i class="fas fa-book"></i> Nueva Receta</h2>
                <button id="btnCerrarModal" style="background: none; border: none; font-size: 28px; cursor: pointer; color: #666;">&times;</button>
            </div>
            
            <form id="formReceta">
                <input type="hidden" name="id_receta">
                
                <!-- Informaci√≥n b√°sica -->
                <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                    <h3 style="margin: 0 0 15px 0; color: #333; font-size: 16px;"><i class="fas fa-info-circle"></i> Informaci√≥n B√°sica</h3>
                    
                    <label style="display: block; margin-bottom: 5px; font-weight: 600;">Nombre de la Receta:</label>
                    <input type="text" name="nombre" required style="width: 100%; padding: 10px; margin-bottom: 15px; border: 1px solid #ddd; border-radius: 5px; box-sizing: border-box;">
                    
                    <label style="display: block; margin-bottom: 5px; font-weight: 600;">Descripci√≥n:</label>
                    <textarea name="descripcion" rows="3" style="width: 100%; padding: 10px; margin-bottom: 15px; border: 1px solid #ddd; border-radius: 5px; box-sizing: border-box;"></textarea>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-weight: 600;">Producto Base (opcional):</label>
                            <select name="id_producto" id="selectProductoBase" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                                <option value="">Sin producto base</option>
                            </select>
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-weight: 600;">Estado:</label>
                            <select name="estado" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                                <option value="true">Activo</option>
                                <option value="false">Inactivo</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Producci√≥n -->
                <div style="background: #e3f2fd; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                    <h3 style="margin: 0 0 15px 0; color: #1976d2; font-size: 16px;"><i class="fas fa-industry"></i> Informaci√≥n de Producci√≥n</h3>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-weight: 600;">Rendimiento:</label>
                            <input type="number" name="rendimiento" step="0.01" min="0.01" required placeholder="Ej: 10" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; box-sizing: border-box;">
                            <small style="color: #666;">Cantidad que produce la receta</small>
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-weight: 600;">Tiempo de Producci√≥n (min):</label>
                            <input type="number" name="tiempo_produccion" min="0" placeholder="Ej: 30" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; box-sizing: border-box;">
                            <small style="color: #666;">Tiempo en minutos</small>
                        </div>
                    </div>
                </div>

                <!-- Ingredientes -->
                <div style="background: #fff3e0; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h3 style="margin: 0; color: #e65100; font-size: 16px;"><i class="fas fa-list"></i> Ingredientes</h3>
                        <button type="button" id="btnAgregarIngrediente" style="background: #ff9800; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; font-size: 14px;">
                            <i class="fas fa-plus"></i> Agregar Ingrediente
                        </button>
                    </div>
                    
                    <div id="listaIngredientes" style="max-height: 300px; overflow-y: auto;">
                        <!-- Los ingredientes se agregar√°n aqu√≠ din√°micamente -->
                    </div>
                    
                    <div id="mensajeIngredientes" style="text-align: center; padding: 20px; color: #999;">
                        <i class="fas fa-info-circle"></i> No hay ingredientes agregados. Haz clic en "Agregar Ingrediente"
                    </div>
                </div>
                
                <button type="submit" style="width: 100%; background: #10b981; color: white; border: none; padding: 12px; border-radius: 5px; cursor: pointer; font-size: 16px; font-weight: 600;">
                    <i class="fas fa-save"></i> Guardar Receta
                </button>
            </form>
        </div>
    </div>

    <!-- Modal Ver Detalles -->
    <div id="modalDetalles" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); justify-content: center; align-items: center; z-index: 1000;">
        <div style="background: white; padding: 30px; border-radius: 10px; width: 90%; max-width: 600px; max-height: 90vh; overflow-y: auto;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2><i class="fas fa-eye"></i> Detalles de Receta</h2>
                <button id="btnCerrarDetalles" style="background: none; border: none; font-size: 28px; cursor: pointer; color: #666;">&times;</button>
            </div>
            <div id="contenidoDetalles"></div>
        </div>
    </div>
</div>

<script>
(async function() {
    console.log('üöÄ Inicializando m√≥dulo de recetas...');
    
    const api = window.api;
    
    if (!api) {
        console.error('‚ùå API no est√° disponible. Aseg√∫rate de cargar api.js antes.');
        return;
    }
    
    const tabla = document.querySelector('#tablaRecetas tbody');
    const modal = document.getElementById('modalReceta');
    const modalDetalles = document.getElementById('modalDetalles');
    const form = document.getElementById('formReceta');
    const btnNueva = document.getElementById('btnNuevaReceta');
    const btnCerrar = document.getElementById('btnCerrarModal');
    const btnCerrarDetalles = document.getElementById('btnCerrarDetalles');
    const selectProductoBase = document.getElementById('selectProductoBase');
    const filtroProducto = document.getElementById('filtroProducto');
    const filtroEstado = document.getElementById('filtroEstado');
    const buscarReceta = document.getElementById('buscarReceta');
    const listaIngredientes = document.getElementById('listaIngredientes');
    const mensajeIngredientes = document.getElementById('mensajeIngredientes');
    const btnAgregarIngrediente = document.getElementById('btnAgregarIngrediente');

    let ingredientesReceta = [];
    let productosDisponibles = [];

    if (!tabla || !modal || !form) {
        console.error('‚ùå Elementos del DOM no encontrados');
        return;
    }

    // ============================================
    // ABRIR/CERRAR MODALES
    // ============================================
    
    btnNueva.onclick = () => {
        form.reset();
        form.querySelector('[name="id_receta"]').value = '';
        ingredientesReceta = [];
        renderizarIngredientes();
        document.getElementById('modalTitle').innerHTML = '<i class="fas fa-book"></i> Nueva Receta';
        modal.style.display = 'flex';
    };

    btnCerrar.onclick = () => modal.style.display = 'none';
    btnCerrarDetalles.onclick = () => modalDetalles.style.display = 'none';
    
    modal.onclick = (e) => {
        if (e.target === modal) modal.style.display = 'none';
    };

    modalDetalles.onclick = (e) => {
        if (e.target === modalDetalles) modalDetalles.style.display = 'none';
    };

    // ============================================
    // CARGAR PRODUCTOS
    // ============================================
    
    async function cargarProductos() {
        try {
            const response = await api.get('/productos?estado=true');
            console.log('üì¶ Respuesta productos:', response.data);
            
            productosDisponibles = response.data.data || response.data;
            
            if (!Array.isArray(productosDisponibles)) {
                console.error('‚ùå Productos no es un array:', productosDisponibles);
                return;
            }
            
            const options = productosDisponibles.map(p => 
                `<option value="${p.id_producto}">${p.nombre} (${p.unidad_medida})</option>`
            ).join('');
            
            selectProductoBase.innerHTML = '<option value="">Sin producto base</option>' + options;
            filtroProducto.innerHTML = '<option value="">Todos los productos</option>' + options;
            
            console.log('‚úÖ Productos cargados:', productosDisponibles.length);
        } catch (error) {
            console.error('‚ùå Error cargando productos:', error);
        }
    }

    // ============================================
    // GESTI√ìN DE INGREDIENTES
    // ============================================
    
    btnAgregarIngrediente.onclick = () => {
        ingredientesReceta.push({
            id_producto: '',
            cantidad: '',
            unidad: 'kg'
        });
        renderizarIngredientes();
    };

    function renderizarIngredientes() {
        if (ingredientesReceta.length === 0) {
            listaIngredientes.style.display = 'none';
            mensajeIngredientes.style.display = 'block';
            return;
        }

        listaIngredientes.style.display = 'block';
        mensajeIngredientes.style.display = 'none';

        listaIngredientes.innerHTML = ingredientesReceta.map((ing, index) => `
            <div style="background: white; border: 1px solid #ddd; border-radius: 5px; padding: 10px; margin-bottom: 10px;">
                <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
                    <div style="flex: 2; min-width: 150px;">
                        <select class="select-ingrediente" data-index="${index}" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 5px;">
                            <option value="">Seleccionar producto</option>
                            ${productosDisponibles.map(p => 
                                `<option value="${p.id_producto}" ${ing.id_producto == p.id_producto ? 'selected' : ''}>
                                    ${p.nombre}
                                </option>`
                            ).join('')}
                        </select>
                    </div>
                    <div style="flex: 1; min-width: 100px;">
                        <input type="number" class="input-cantidad" data-index="${index}" 
                               value="${ing.cantidad}" placeholder="Cantidad" step="0.01" min="0.01"
                               style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 5px;">
                    </div>
                    <div style="flex: 1; min-width: 100px;">
                        <select class="select-unidad" data-index="${index}" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 5px;">
                            <option value="kg" ${ing.unidad === 'kg' ? 'selected' : ''}>kg</option>
                            <option value="g" ${ing.unidad === 'g' ? 'selected' : ''}>g</option>
                            <option value="l" ${ing.unidad === 'l' ? 'selected' : ''}>l</option>
                            <option value="ml" ${ing.unidad === 'ml' ? 'selected' : ''}>ml</option>
                            <option value="unidad" ${ing.unidad === 'unidad' ? 'selected' : ''}>unidad</option>
                        </select>
                    </div>
                    <button type="button" class="btn-eliminar-ingrediente" data-index="${index}" 
                            style="background: #ef4444; color: white; border: none; padding: 8px 12px; border-radius: 5px; cursor: pointer;">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
        `).join('');

        // Event listeners para ingredientes
        document.querySelectorAll('.select-ingrediente').forEach(select => {
            select.onchange = (e) => {
                const index = parseInt(e.target.dataset.index);
                ingredientesReceta[index].id_producto = e.target.value;
            };
        });

        document.querySelectorAll('.input-cantidad').forEach(input => {
            input.oninput = (e) => {
                const index = parseInt(e.target.dataset.index);
                ingredientesReceta[index].cantidad = e.target.value;
            };
        });

        document.querySelectorAll('.select-unidad').forEach(select => {
            select.onchange = (e) => {
                const index = parseInt(e.target.dataset.index);
                ingredientesReceta[index].unidad = e.target.value;
            };
        });

        document.querySelectorAll('.btn-eliminar-ingrediente').forEach(btn => {
            btn.onclick = (e) => {
                const index = parseInt(e.target.closest('button').dataset.index);
                ingredientesReceta.splice(index, 1);
                renderizarIngredientes();
            };
        });
    }

    // ============================================
    // CARGAR RECETAS
    // ============================================
    
    async function cargarRecetas() {
        try {
            console.log('üìö Cargando recetas...');
            
            const params = new URLSearchParams();
            
            const buscar = buscarReceta.value.trim();
            const producto = filtroProducto.value;
            const estado = filtroEstado.value;
            
            if (estado) params.append('estado', estado);
            if (producto) params.append('id_producto', producto);
            
            const queryString = params.toString();
            const url = queryString ? `/recetas?${queryString}` : '/recetas';
            
            console.log('üîç URL de b√∫squeda:', url);
            
            const response = await api.get(url);
            console.log('üìö Respuesta recetas:', response.data);
            
            let recetas = response.data.data || response.data;
            
            if (!Array.isArray(recetas)) {
                console.error('‚ùå Recetas no es un array:', recetas);
                tabla.innerHTML = '<tr><td colspan="7" style="text-align:center; padding: 20px; color: red;">Error: Formato de datos incorrecto</td></tr>';
                return;
            }

            // Filtrar por b√∫squeda local
            if (buscar) {
                recetas = recetas.filter(r => 
                    r.nombre.toLowerCase().includes(buscar.toLowerCase()) ||
                    (r.descripcion && r.descripcion.toLowerCase().includes(buscar.toLowerCase()))
                );
            }
            
            console.log('‚úÖ Recetas cargadas:', recetas.length);
            
            if (recetas.length === 0) {
                tabla.innerHTML = '<tr><td colspan="7" style="text-align:center; padding: 20px; color: #666;">No se encontraron recetas</td></tr>';
                return;
            }
            
            tabla.innerHTML = recetas.map(r => `
                <tr>
                    <td style="padding: 12px; border-bottom: 1px solid #e5e7eb;">
                        <strong>${r.nombre || 'N/A'}</strong>
                        ${r.descripcion ? `<br><small style="color: #666;">${r.descripcion}</small>` : ''}
                    </td>
                    <td style="padding: 12px; border-bottom: 1px solid #e5e7eb;">${r.producto_nombre || 'Sin producto'}</td>
                    <td style="padding: 12px; border-bottom: 1px solid #e5e7eb;">${parseFloat(r.rendimiento || 0).toFixed(2)}</td>
                    <td style="padding: 12px; border-bottom: 1px solid #e5e7eb;">${r.tiempo_produccion ? r.tiempo_produccion + ' min' : 'N/A'}</td>
                    <td style="padding: 12px; border-bottom: 1px solid #e5e7eb;">
                        <button class="btn-ver" data-id="${r.id_receta}" style="background: #6366f1; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer;">
                            <i class="fas fa-eye"></i> Ver
                        </button>
                    </td>
                    <td style="padding: 12px; border-bottom: 1px solid #e5e7eb;">
                        <span style="background: ${r.estado ? '#10b981' : '#ef4444'}; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px;">
                            ${r.estado ? 'Activo' : 'Inactivo'}
                        </span>
                    </td>
                    <td style="padding: 12px; border-bottom: 1px solid #e5e7eb;">
                        <button class="btn-edit" data-id="${r.id_receta}" style="background: #3b82f6; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; margin-right: 5px;">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn-delete" data-id="${r.id_receta}" style="background: #ef4444; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer;">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `).join('');

            // Event delegation
            tabla.querySelectorAll('.btn-ver').forEach(btn => {
                btn.onclick = () => verDetalles(btn.dataset.id);
            });
            tabla.querySelectorAll('.btn-edit').forEach(btn => {
                btn.onclick = () => editarReceta(btn.dataset.id);
            });
            tabla.querySelectorAll('.btn-delete').forEach(btn => {
                btn.onclick = () => eliminarReceta(btn.dataset.id);
            });

        } catch (error) {
            console.error('‚ùå Error al cargar recetas:', error);
            tabla.innerHTML = `
                <tr>
                    <td colspan="7" style="text-align:center; padding: 20px; color: red;">
                        Error al cargar recetas: ${error.response?.data?.message || error.message}
                    </td>
                </tr>
            `;
        }
    }

    // ============================================
    // VER DETALLES
    // ============================================
    
    async function verDetalles(id) {
        try {
            const response = await api.get(`/recetas/${id}`);
            const receta = response.data.data || response.data;
            
            const contenido = document.getElementById('contenidoDetalles');
            contenido.innerHTML = `
                <div style="margin-bottom: 20px;">
                    <h3 style="color: #333; margin-bottom: 10px;">${receta.nombre}</h3>
                    ${receta.descripcion ? `<p style="color: #666; margin-bottom: 15px;">${receta.descripcion}</p>` : ''}
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                        <div style="background: #f8f9fa; padding: 10px; border-radius: 5px;">
                            <strong>Producto Base:</strong><br>
                            ${receta.producto_nombre || 'Sin producto'}
                        </div>
                        <div style="background: #f8f9fa; padding: 10px; border-radius: 5px;">
                            <strong>Rendimiento:</strong><br>
                            ${receta.rendimiento} ${receta.producto_unidad || ''}
                        </div>
                        <div style="background: #f8f9fa; padding: 10px; border-radius: 5px;">
                            <strong>Tiempo:</strong><br>
                            ${receta.tiempo_produccion || 'N/A'} minutos
                        </div>
                        <div style="background: #f8f9fa; padding: 10px; border-radius: 5px;">
                            <strong>Estado:</strong><br>
                            <span style="color: ${receta.estado ? '#10b981' : '#ef4444'};">
                                ${receta.estado ? '‚úÖ Activo' : '‚ùå Inactivo'}
                            </span>
                        </div>
                    </div>
                    
                    <h4 style="color: #333; margin-bottom: 10px;"><i class="fas fa-list"></i> Ingredientes</h4>
                    <div style="background: #fff3e0; padding: 15px; border-radius: 5px;">
                        ${receta.ingredientes && receta.ingredientes.length > 0 ? 
                            receta.ingredientes.map(ing => `
                                <div style="display: flex; justify-content: space-between; padding: 8px; border-bottom: 1px solid #ffe0b2;">
                                    <span><i class="fas fa-circle" style="font-size: 6px; color: #ff9800;"></i> ${ing.ingrediente_nombre}</span>
                                    <strong>${ing.cantidad} ${ing.unidad}</strong>
                                </div>
                            `).join('') 
                            : '<p style="text-align: center; color: #999;">Sin ingredientes</p>'
                        }
                    </div>
                </div>
            `;
            
            modalDetalles.style.display = 'flex';
        } catch (error) {
            console.error('Error:', error);
            alert('‚ùå Error al cargar detalles');
        }
    }

    // ============================================
    // GUARDAR RECETA
    // ============================================
    
    form.onsubmit = async (e) => {
        e.preventDefault();
        
        // Validar ingredientes
        if (ingredientesReceta.length === 0) {
            alert('‚ö†Ô∏è Debe agregar al menos un ingrediente');
            return;
        }

        const ingredientesValidos = ingredientesReceta.filter(ing => 
            ing.id_producto && ing.cantidad && parseFloat(ing.cantidad) > 0
        );

        if (ingredientesValidos.length === 0) {
            alert('‚ö†Ô∏è Complete todos los campos de los ingredientes');
            return;
        }

        const formData = new FormData(form);
        const data = Object.fromEntries(formData);
        
        data.estado = data.estado === 'true';
        data.rendimiento = parseFloat(data.rendimiento);
        data.tiempo_produccion = data.tiempo_produccion ? parseInt(data.tiempo_produccion) : null;
        
        if (!data.id_producto) {
            delete data.id_producto;
        }

        // Agregar ingredientes
        data.ingredientes = ingredientesValidos.map(ing => ({
            id_producto: parseInt(ing.id_producto),
            cantidad: parseFloat(ing.cantidad),
            unidad: ing.unidad
        }));

        try {
            const idReceta = data.id_receta;
            
            if (idReceta) {
                await api.put(`/recetas/${idReceta}`, data);
                alert('‚úÖ Receta actualizada correctamente');
            } else {
                delete data.id_receta;
                await api.post('/recetas', data);
                alert('‚úÖ Receta creada correctamente');
            }
            
            modal.style.display = 'none';
            cargarRecetas();
            
        } catch (error) {
            console.error('Error al guardar:', error);
            alert('‚ùå Error al guardar receta: ' + (error.response?.data?.message || error.message));
        }
    };

    // ============================================
    // EDITAR RECETA
    // ============================================
    
    async function editarReceta(id) {
        try {
            const response = await api.get(`/recetas/${id}`);
            const r = response.data.data || response.data;
            
            form.querySelector('[name="id_receta"]').value = r.id_receta;
            form.querySelector('[name="nombre"]').value = r.nombre;
            form.querySelector('[name="descripcion"]').value = r.descripcion || '';
            form.querySelector('[name="id_producto"]').value = r.id_producto || '';
            form.querySelector('[name="rendimiento"]').value = r.rendimiento;
            form.querySelector('[name="tiempo_produccion"]').value = r.tiempo_produccion || '';
            form.querySelector('[name="estado"]').value = r.estado.toString();
            
            // Cargar ingredientes
            ingredientesReceta = (r.ingredientes || []).map(ing => ({
                id_producto: ing.id_producto,
                cantidad: ing.cantidad,
                unidad: ing.unidad
            }));
            
            renderizarIngredientes();
            
            document.getElementById('modalTitle').innerHTML = '<i class="fas fa-edit"></i> Editar Receta';
            modal.style.display = 'flex';
            
        } catch (error) {
            console.error('Error:', error);
            alert('‚ùå Error al cargar receta para editar');
        }
    }

    // ============================================
    // ELIMINAR RECETA
    // ============================================
    
    async function eliminarReceta(id) {
        if (!confirm('¬øEst√°s seguro de eliminar esta receta?')) return;
        
        try {
            await api.delete(`/recetas/${id}`);
            alert('‚úÖ Receta eliminada correctamente');
            cargarRecetas();
        } catch (error) {
            console.error('Error:', error);
            alert('‚ùå Error al eliminar receta: ' + (error.response?.data?.message || error.message));
        }
    }

    // ============================================
    // EVENTOS DE FILTROS
    // ============================================
    
    let timeoutBusqueda;
    
    buscarReceta.addEventListener('input', () => {
        clearTimeout(timeoutBusqueda);
        timeoutBusqueda = setTimeout(() => {
            console.log('üîç Buscando:', buscarReceta.value);
            cargarRecetas();
        }, 500);
    });

    filtroProducto.addEventListener('change', () => {
        console.log('üì¶ Filtro producto:', filtroProducto.value);
        cargarRecetas();
    });

    filtroEstado.addEventListener('change', () => {
        console.log('üîò Filtro estado:', filtroEstado.value);
        cargarRecetas();
    });

    // ============================================
    // INICIALIZAR
    // ============================================
    
    await cargarProductos();
    await cargarRecetas();
    
    console.log('‚úÖ M√≥dulo de recetas inicializado correctamente');
})();
</script>